<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Elasticsearch and Drupal</title>

    <meta name="author" content="Bec White">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="palantir/palantir.css" id="theme">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
      document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->


    <style type="text/css">

    ul.inline {
      margin: 0;
      padding: 0;
      list-style-type: none;
      text-align: center;
    }

    ul.inline li {
      display: inline;
    }

    /*overwrites a default style that
    vertically un-centered slides */
    .reveal .slides>section,
    .reveal .slides>section>section {
      padding: 0px;
    }


    div.horiz-flowchart {
      display: flex;
      align-items: center;
      justify-content: space-around;
      flex-flow: row wrap;
    }
    div.horiz-flowchart > div {
      margin: auto;
    }

    ul.horiz-list {
      display: flex;
      align-items: flex-start;
      justify-content: space-around;
      flex-wrap: nowrap;
      list-style-type: none;
    }
    ul.horiz-list > li > h3 {
      text-align: center;
    }

    .reveal ul > ul {
      margin-top: 2em;
    }

    </style>

  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section>
          <h2>Elasticsearch and Drupal</h2>
          <p><small>Presented by Bec White (<a href="http://twitter.com/becw">@becw</a>), Senior Engineer at <a href="http://palantir.net/">Palantir.net</a></small></p>
          <p><small>Prepared for <a href="http://2014.drupalcampfv.org/">DrupalCamp Fox Valley</a>, September 2014</small></p>
        </section>

<section>
  <h2>"You Know, for Search"</h2>
  <aside class="notes">
    <p>Site search, but also working with tons of data, and also as a fast data backend for a JSON API.</p>
    <p>Let's start with site search, though.</p>
  </aside>
</section>

<section>
  <h2>Search tools you may be familiar with...</h2>
  <ul>
    <li>Drupal core search</li>
    <li>Apache Solr</li>
    <li>Sphinx</li>
    <li>Google Search Appliance</li>
    <li class="fragment"><strong>Elasticsearch</strong></li>
  </ul>
</section>

<section>
  <h2>Elasticsearch is...</h2>
  <ul>
    <li>An open source search server</li>
    <li>Based on the Lucene search engine (like Solr)</li>
    <li>Distributed and scalable</li>
    <li>Speaks JSON</li>
  </ul>
</section>

<section>
  <h2>What is a search server?</h2>
  <ul>
    <li class="fragment">Analyzes text content from your site</li>
    <li class="fragment">Analyzes queries from your users</li>
    <li class="fragment">Finds matches between the two</li>
  </ul>

  <aside class="notes">
    <p>Generally, your site sends data to the search server when your content is updated--hook_node_save()</p>
    <p>usually you will just queue content for "indexing" in hook_node_save(), because performance. then it gets indexed on cron.</p>
    <p>analysis happens when content is indexed. indexing associates the original document (via id, link, other metadata) with its analyzed content.</p>
    <p>"analysis" is making generalizations like:
      <ul>
        <li>The document contains the words "search", "for", "an", "answer"</li>
        <li>The word "search" is rare among this body of documents</li>
        <li>The word "Searching" is equivalent to the word "search"</li>
      </ul>
    </p>
    <p>happens on both content and queries!</p>
    <p>analysis--of content, and of queries--are the basis for returning search results</p>
    <p>the processing/generalizations are useful beyond just searches:
      <ul>
        <li>add depth like spelling suggestions and "more like this" to searches</li>
        <li>improve sorting (remove leading "the", "a", or punctuation, transliterate)</li>
        <li>allow efficient sorting and filtering of large datasets</li>
      </ul>
    </p>
  </aside>
</section>

<section>
  <h2>When is a search server necessary?</h2>
  <ul>
    <li class="fragment">For full text search</li>
    <li class="fragment">When you have lots of content</li>
    <li class="fragment">When Drupal isn't optimized for the kind of queries you want to perform</li>
  </ul>
</section>

<section>
  <h2>What is "full text search"?</h2>
  <p class="fragment">Matching documents that don't contain the exact query.</p>
  <p class="fragment">The query "answer search" should match a document that contains "Searching for an answer"</p>

  <aside class="notes">
    <p>Views "contains" text searches (case-insensitive because MySQL configuration but otherwise exact match only)</p>
    <p>SQL LIKE wildcard queries</p>
    <p>Drupal core search (analyzes text), so actually can be sufficient when you don't have too much content and don't need fancy features</p>
  </aside>
</section>

<section>
  <h2>What is "lots of documents"?</h2>
  <p class="fragment">In Drupal, over 10,000 documents.</p>
  <p class="fragment">(Nodes are documents)</p>
  <aside class="notes">
    <p>Drupal core search performs poorly. After about 5,000 to 10,000 documents it becomes noticeable; after 20,000, it is unbearable.</p>
  </aside>
</section>
<section>
  <h2>Drupal? Not optimized?</h2>
  <p class="fragment">Yes, for things like:</p>
  <ul>
    <li class="fragment">Listing, sorting, and filtering tens of thousands to millions of nodes</li>
    <li class="fragment">Responding promptly with a limited set of information from a node</li>
    <li class="fragment">Smart autocomplete</li>
    <li class="fragment">Textual analysis (like related content)</li>
  </ul>
  <aside class="notes">
    <p>When a query seems slow due to scale and complexity, consider shifting it to Elasticsearch instead of optimizing MySQL</p>
  </aside>
</section>

<section>
  <h2>Say we have thousands of documents and want full text search...</h2>
</section>

<section>
  <h2>What next?</h2>
  <ul>
    <li>Get an Elasticsearch server</li>
    <li>Install some modules</li>
    <li>Click a lot</li>
  </ul>
</section>

<section>
  <h2>Running Elasticsearch for development</h2>
  <a href="https://gist.github.com/becw/06bc47ce2dc8a7205ed8">Vagrant setup</a>
</section>

<section>
  <h2>Beware</h2>
  <p>Elasticsearch doesn't do access control. You <strong>must</strong> configure that outside of Elasticsearch.</p>
</section>

<section>
  <h2>Which modules?</h2>
  <ul>
    <li>Entity</li>
    <li>Search API</li>
    <li>Composer Manager</li>
    <li>Elasticsearch Connector</li>
  </ul>
</section>

<section>
  <pre>$ drush dl entity search_api composer_manager elasticsearch_connector
$ drush en composer_manager elasticsearch_connector_search_api search_api_views</pre>
</section>

<section>
  <h2>Elasticsearch Connector</h2>
  <ul>
    <li><a href="http://drupal.org/project/elasticsearch_connector">http://drupal.org/project/elasticsearch_connector</a></li>
    <li>Depends on the Elasticsearch PHP library</li>
    <li>Thin layer to connect to an Elasticsearch cluster</li>
    <li>Includes a separate Search API integration module</li>
  </ul>
  <aside class="notes">
    <p>The Elasticsearch PHP library is Apache2 licensed.</p>
    <p>"easy install" option - don't use it, use composer manager + composer instead</p>
  </aside>
</section>

<section>
  <h2>Configuration checklist</h2>
  <ul>
    <li>Elasticsearch Connector cluster</li>
    <li>Search API server</li>
    <li>Search API index</li>
    <li>A search view</li>
  </ul>
</section>

<section>
  <h2>Terminology overload</h2>
  <ul class="fragment">
    <li>Elasticsearch has "clusters", "nodes", "indexes", and "types"</li>
    <li>Elasticsearch Connector has "clusters"</li>
    <li>Search API has "servers" and "indexes"</li>
  </ul>
  <br /><br />
  <h2 class="fragment">Your "Search API index" does not correspond with an "Elasticsearch index"</h2>
  <aside class="notes">
    <ul>
      <li>Elasticsearch Connector "clusters" manage connections to search servers</li>
      <li>Search API "servers" correspond with "clusters"</li>
      <li>Search API "indexes" configure how specific content is indexed</li>
    </ul>
  </aside>
</section>

<section>
  <h2>Search API indexes</h2>
  <h3>Configure how content is indexed</h3>
  <p>This is not specific to Elasticsearch, but has some Elasticsearch-specific options.</p>
  <ul class="fragment">
    <li>Which fields are searchable?</li>
    <li>How are they searchable?</li>
    <li>Should any nodes be excluded?</li>
    <li>Should additional data be included in the index?</li>
    <li>Data "type" name (Elasticsearch)</li>
    <li>Result highlighting (Elasticsearch)</li>
  </ul>
</section>

<section>
  <h2>Fancy toppings</h2>
  <ul>
    <li>Views</li>
    <li>Facet API</li>
  </ul>
  <aside class="notes">
    <p>enable the views or facetapi module, then enable the corresponding search api module.</p>
  </aside>
</section>

<section>
  <h2>Search concepts</h2>
  <ul class="fragment">
    <li>Tokens</li>
    <li>Field types</li>
    <li>Queries and filters</li>
    <li>Facets</li>
  </ul>
</section>

<section>
  <h2>Tokens</h2>
  <ul>
    <li class="fragment">Case and punctuation</li>
    <li class="fragment">Stemming ("searching" => "search")</li>
    <li class="fragment">Stop words ("a", "an", "the", "for")</li>
  </ul>
</section>

<section>
  <h2>Field types</h2>
  <p>Elasticsearch field configuration determines how data is analyzed for search.</p>
  <ul class="fragment">
    <li>full text</li>
    <li>term</li>
    <li>number</li>
    <li>date</li>
  </ul>
  <aside class="notes">
    <p>Use term fields for things that require exact match--facets are an important example of this. or sorting.</p>
  </aside>
</section>

<section>
  <h2>Queries vs. filters</h2>
  <ul class="fragment">
    <li>Queries are for full-text search</li>
    <li>Filters limit by and exact value</li>
    <li>… and support caching</li>
  </ul>
  <aside class="notes">
    <p>Can configure which is used when building Search API Views</p>
  </aside>
</section>

<section>
  <h2>Facets</h2>
  <ul class="fragment">
    <li>Think categories on shopping sites</li>
    <li>Allow narrowing searches by field values that appear in the results</li>
    <li>Provide counts per value</li>
    <li>Facet API provides core blocks and panel panes to display facet data</li>
  </ul>
</section>

<section>
  <h2>Poking Elasticsearch</h2>
  <ul>
    <li>elasticsearch-head</li>
    <li>http://localhost:9200/_plugin/head/</li>
    <li>Examining index configuration</li>
    <li>Viewing records</li>
    <li>Testing API calls</li>
  </ul>
</section>

<section>
  <h2>Custom integration</h2>
  <ul class="fragment">
    <li>Why would you customize?</li>
    <li>Which PHP library?</li>
    <li>Which Javascript library?</li>
  </ul>
</section>

<section>
  <h2>Why would you customize?</h2>
  <ul class="fragment">
    <li><strong>The default "full text" analyzer doesn't do stemming</strong></li>
    <li>Your data contains diacritics or accented characters</li>
    <li>To use Elasticsearch as an autocomplete backend</li>
    <li>You read something cool in the Elasticsearch docs</li>
  </ul>
</section>

<section>
  <h2>At Palantir.net, we've used Elasticsearch...</h2>
  <p>... for special cases, when needs went far beyond "site search".</p>
</section>

<section>
  <h2>Such as?</h2>
  <ul class="fragment">
    <li>As a fast, decoupled data backend for an API service</li>
    <li>To provide fuzzy autocomplete matching</li>
    <li>For an inline lookup widget with super fast filtering and searching across millions of records</li>
    <li>For generating views of millions of records, for faceting, for views-based record search</li>
  </ul>
</section>

<section>
  <h2>Elasticsearch Libraries</h2>
  <p>Find them on <a href="http://www.elasticsearch.org/">Elasticsearch.org</a>.</p>
  <ul>
    <li><a href="http://www.elasticsearch.org/guide/en/elasticsearch/client/php-api/current/index.html">PHP library</a></li>
    <li>Get the PHP library with Composer.</li>
    <li><a href="http://www.elasticsearch.org/guide/en/elasticsearch/client/javascript-api/current/index.html">Javascript library</a></li>
    <li>jQuery integration requires jQuery 1.5 or newer (in Drupal, this means using jQuery Update)</li>
  </ul>
</section>

<section>
  <h2>Fun features</h2>
  <ul>
    <li>More like this</li>
    <li>Percolate</li>
    <li>Explain</li>
    <li>Analyze</li>
  </ul>
</section>

        <section id="final">
          <p><a href="http://www.palantir.net/">Palantir.net</a></p>
          <p>Let's make something good together</p>
          <p>Keep tabs on our work at <a href="http://twitter.com/Palantir">@Palantir</a></p>
          <p>Want to hear about <a href="http://eepurl.com/ws6uj">what we're doing</a>?</p>
        </section>
      </div>
    </div>

    <footer class="palantir-logo">
      <a href="http://www.palantir.net/"><img src="palantir/palantirnet-logo-4c-reversed.svg" alt="Palantir.net logo" height="37" /></a>
    </footer>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.min.js"></script>

    <script>

      // Full list of configuration options available here:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

        // Parallax scrolling
        // parallaxBackgroundImage: 'https://s3.amazonaws.com/hakim-static/reveal-js/reveal-parallax-1.jpg',
        // parallaxBackgroundSize: '2100px 900px',

        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });

    </script>
  </body>
</html>
